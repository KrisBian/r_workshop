{
    "contents" : "#------------------------------------------------------------#\n#                                                            #\n#         Introduction to data analysis with R               #\n#                                                            #\n#------------------------------------------------------------#\n\nlibrary(xlsx)  ## require To read the excel (.xlsx) files\nlibrary(gdata)\n\n### Set working directory : All the Finala we read and write will be in this directory ###\n# setwd('~/Desktop/R_intro')\n\n## Read The Finala from .csv file ##\nFinal<- read.csv('data/R_intro_data.csv', header = T)\n\n## Read The Finala from .xlsx file ##\nFinal_xlsx<- read.xlsx(\"data/R_intro_excel.xlsx\", sheetName=\"Data\")\n# Final_xlsx <- read.xls(\"data/R_intro_excel.xlsx\", sheet=1, header=TRUE)\n\n#--------------------------------------------------#\n#                                                  #\n#                Data management                   #\n#                                                  #\n#--------------------------------------------------#\n\n\n## Check dimensions and names and type of variables ##\ndim(Final)\ndata.frame(names(Final))\nhead(Final)\nsummary(Final)\n\n## For categorical variables: Check table, proportion tables and plots ##\ny<- summary(Final$Race)\ncbind(y, prop.table(y))\ncbind(y, prop.table(y)*100)\npaste(y, \" (\", prop.table(y)*100, \"%\", \")\", sep=\"\") \n\n## What would be different if y<- table(Final$Sex) \npaste(table(Final$Race), \" (\", prop.table(table(Final$Race))*100, \"%\", \")\", sep=\"\") \n\n## Same way do it for race, area, smoke and ses ##\n\n\n\n######  Missing value and cleaning the data for categorical data  ####### \n\nsum(is.na(Final$Sex))\nsum(is.na(Final$Race))\nsum(is.na(Final$Area))\nsum(is.na(Final$SES))\nsum(is.na(Final$smoke))\n\nFinal$smoke[Final$smoke==-1]<- NA\nFinal$Race[is.na(Final$Race)]<- 3   ## What Happens??\n\nFinal$Race<- as.numeric(Final$Race)\nFinal$Race[is.na(Final$Race)]<- max(Final$Race)+1\nsummary(Final$Race)\n\nFinal$Race[is.na(Final$Race)]<- max(Final$Race, na.rm = T)+1\n\nFinal$Race<- factor(Final$Race, labels = c(\"Other\", \"White\", \"Missing\"))\n\n\nFinal$SES<- as.numeric(Final$SES)\n\nFinal$SES[is.na(Final$SES)]<- max(Final$SES, na.rm = T)+1\n\nFinal$SES<- factor(Final$SES, labels = c(\"High\", \"Midium\", \"Low\", \"Missing\"))\n\n\n###  Some Simple plots  ###\n\nSES<- table(Final$SES)\n\nx<-barplot(SES, names.arg=c(\"High\", \"Medium\", \"Low\", \"Missing\"))\n\nx<-barplot(SES, names.arg=c(\"High\", \"Medium\", \"Low\", \"Missing\"), ylim=c(0,60))\n\nx<-barplot(SES, names.arg=c(\"High\", \"Medium\", \"Low\", \"Missing\"), ylim=c(0,60), \n           ylab=\"Percent(%)\", xlab=\"Socio Economic Status\", col=c(\"Blue\", \"Green\", \"Red\", \"Yellow\"))\n\npar(family = 'serif')\n\nx<-barplot(SES, names.arg=c(\"High\", \"Medium\", \"Low\", \"Missing\"), ylim=c(0,60), ylab=\"Percent(%)\", xlab=\"Socio Economic Status\", col=c(\"Blue\", \"Green\", \"Red\", \"Yellow\"), main=\"Figure 3A: Socio Economic Status of some group in Ontario area with Lung cancer incidences\")\n\n\nx<-barplot(SES, names.arg=c(\"High\", \"Medium\", \"Low\", \"Missing\"), \n           ylim=c(0,60), \n           ylab=\"Percent(%)\", xlab=\"Socio Economic Status\", \n           col=c(\"Blue\", \"Green\", \"Red\", \"Yellow\"), \n           main=\"Figure 3A: Socio Economic Status of some group \\n in\nOntario area with \n           Lung cancer \\n incidences\")\ntext(x,SES+2,labels=round(SES,0), col=\"Black\")\n\n## For two variables\n\nSES_smk<- prop.table(table(Final$SES, Final$smoke),2)\n\n## Stack plot\nx<-barplot(SES_smk*100, names.arg=c(\"Non smoker\", \"Smoker\"), \n           ylim=c(0,100), ylab=\"Percent(%)\", xlab=\"Socio Economic Status\", \n           col=c(\"Blue\", \"Green\", \"Red\", \"Yellow\"), \n           main=\"Figure 3A: Socio Economic Status of some group \\n in Ontario area with Lung cancer \\n incidences\")\n\n## Side by side\nx<-barplot(SES_smk*100, names.arg=c(\"Non smoker\", \"Smoker\"), ylim=c(0,50), ylab=\"Percent(%)\", xlab=\"Socio Economic Status\", col=c(\"Blue\", \"Green\", \"Red\", \"Yellow\"), main=\"Figure 3A: Socio Economic Status of some group \\n in Ontario area with Lung cancer \\n incidences\", beside = T, cex.main=0.8)\ntext(x,SES_smk*100+2,labels=round(SES_smk*100,0), col=\"Black\")\n\n\n####   Bivariate Association  ####\n\ntab<- table(Final$Sex, Final$smoke)\n\nprop.table(tab)\n\nprop.table(tab, margin = 1)\n\nround(prop.table(tab, margin = 2), 2)#*100\n\nchisq.test(Final$Sex, Final$smoke)\n\n#chisq.test(Final$Sex[!is.na(Final$smoke)], Final$smoke[!is.na(Final$smoke)])\n\n\n## For Continuous variables: Check mean, SD, summary and plots ##\n\n#  For the Age variable: A covariate, possible confounder  ##  \n\nmean(Final$Age)   ### Why??\n\nmean(Final$Age, na.rm = T)\n\nsd(Final$Age, na.rm = T)\n\nsummary(Final$Age)\n\nboxplot(Final$Age)\n\nhist(Final$Age)\n\nFinal$Age[is.na(Final$Age)]<- 99\n\nFinal$Cat_Age<- cut(Final$Age, quantile(Final$Age, prob=c(0.0, 0.2, 0.4, 0.6, 0.8, 1), labels=F))\n\nFinal$Cat_Age<- cut(Final$Age, c(59, 65, 71, 99))\n\nFinal$Cat_Age<- cut(Final$Age, c(59, 65, 71, 99), labels = c(\"60-65\", \"65-70\", \"Missing\"))\n\n\n#  For the Blood pressure variable: Exposure for survival analysis and one of the outcomes  #  \n\nmean(Final$BP, na.rm = T)\n\nsd(Final$BP, na.rm = T)\n\nwhich(is.na(Final$BP))\n\nsummary(Final$BP)\n\nboxplot(Final$BP)\n\nboxplot(Final$BP~Final$Sex)\n\nboxplot(Final$BP~Final$Sex + Final$smoke)\n\nhist(Final$BP)\n\n\n## Summarizing blood pressure by categorical variables ##\n\nx<-aggregate(Final$BP, by = list(Final$SES, Final$smoke), mean, na.rm = T)\n\ncolnames(x)<- c(\"SES\", \"Smoking\", \"BP\")\n\nxtabs(x$BP~ x$SES + x$Smoking)\n\nround(xtabs(x$BP~ x$SES + x$Smoking), 2)\n\n\n\n\n#-----------------------------------------------#\n#                                               #\n#                Data Analysis                  #\n#                                               #\n#-----------------------------------------------#\n\n\n## Linear regression prediction and confidence intervals\n\nlr_BP<- lm(BP ~ smoke + SES + Cat_Age + Sex + Race + Area, data = Final)\n\nlr_BP<- lm(BP ~ Age, data = Final)\n\nplot(Final$Age, Final$BP)\n\nk<-cbind(k<-loess.smooth(Final$Age, Final$BP)$x, loess.smooth(Final$Age, Final$BP)$y)\n\nplot(k[,1], k[,2], main=\"Lowess smoth graphs\",type = 'l', xlab = \"Age in years\", ylab=\"Average BP\", col = \"Red\", lwd = 2, xlim = c(60,100))\n\nlr_BP<- lm(BP ~ Age, data = Final[Final$Age!=99 & !is.na(Final$BP),])\n\nk<-cbind(k<-loess.smooth(Final$Age[Final$Age!=99], Final$BP[Final$Age!=99])$x, loess.smooth(Final$Age[Final$Age!=99], Final$BP[Final$Age!=99])$y)\n\nplot(k[,1], k[,2], main=\"Lowess smoth graphs\",type = 'l', xlab = \"Age in years\", ylab=\"Average BP\", col = \"Red\", lwd = 2, xlim = c(60,70))\n\nconf<-predict(lr_BP, interval=c(\"confidence\"))\nprd<-predict(lr_BP, interval=c(\"prediction\"))\n\npred<- cbind(Final$Age[Final$Age!=99 & !is.na(Final$BP)], conf[,1], conf[,2], conf[,3], prd[,2], prd[,3])\n\npred<- pred[order(pred[,1]),]\n\nplot(pred[,1], pred[,2], type = \"l\", lty = 1, col = \"black\", ylim=c(50,100), xlab = \"Age in years\", ylab=\"Predicted Blood Pressure\", main = \"Prediction and confidence interval\")\nlines(pred[,1], pred[,3], lty = 1, col = \"red\")\nlines(pred[,1], pred[,4], lty = 1, col = \"red\")\nlines(pred[,1], pred[,5], lty = 2, col = \"blue\")\nlines(pred[,1], pred[,6], lty = 2, col = \"blue\")\n\npdf(\"Figure 1\", pointsize = 13)\npar(family='serif')\nplot(pred[,1], pred[,2], type = \"l\", lty = 1, col = \"black\", ylim=c(50,100), xlab = \"Age in years\", ylab=\"Predicted Blood Pressure\", main = \"Prediction and confidence interval\", bty = 'n')\nlines(pred[,1], pred[,3], lty = 1, col = \"red\")\nlines(pred[,1], pred[,4], lty = 1, col = \"red\")\nlines(pred[,1], pred[,5], lty = 2, col = \"blue\")\nlines(pred[,1], pred[,6], lty = 2, col = \"blue\")\ndev.off()\n\n\n## Logistic regression\n\nglm_smk<- glm(smoke ~ Race + Sex + Cat_Age + SES + Area , data = Final, family = binomial(link = \"logit\"))\n\nglm_smk<- glm(smoke ~ Sex + Cat_Age + SES + Area , data = Final, family = binomial(link = \"logit\"))\n\n\n#### Managing dates ####\n\nas.Date(\"01/01/2010\", \"%d/%m/%Y\")\n\nas.Date(\"01/01/2010\", \"%d/%m/%y\")\n\nas.Date(\"01/01/2010\", \"%d/%M/%Y\")\n\n\n#### Managing the dates in the data and calculating survival time  ####\n\nFinal$start1<- as.Date(Final$Start, \"%d/%m/%Y\")\n\nFinal$stop1<- as.Date(Final$stop, \"%d/%m/%Y\")\n\nFinal$surv<- as.numeric(Final$stop1) - as.numeric(Final$start1)\n\nFinal$start2<-as.POSIXct(strptime(Final$Start, \"%d/%m/%Y\"))\n\nFinal$stop2<-as.POSIXct(strptime(Final$stop, \"%d/%m/%Y\"))\n\nFinal$surv1<- as.numeric(Final$stop2) - as.numeric(Final$start2)\n\n\n### Survival Analysis ####\n\nlibrary(survival)\n\ny<- coxph(Surv(surv, event) ~ Cat_Age + Sex + smoke + BP + Race + Area + SES, data = Final)\ny<- coxph(Surv(surv, event) ~ Cat_Age + Sex + smoke + BP + Area + SES, data = Final)\n\nest<-exp(coef(y))\n\nCI<- exp(confint(y))\n\nest_CI<- paste(round(est,2), \" (\", round(CI[,1],2), \", \", round(CI[,2], 2), \")\", sep=\"\")\n\nest_CI_p<- cbind(est_CI, round(summary(y)$coefficients[,5],2))\n\ncolnames(est_CI_p)<- c(\"HR (95% CI)\", \"p-value\")\n\n\nwrite.csv(est_CI_p, \"Hazard Ratio Estimate.csv\")\n\n# http://www.stat.berkeley.edu/~s133/dates.html\n",
    "created" : 1508100428497.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1469374569",
    "id" : "91A4539F",
    "lastKnownWriteTime" : 1508180867,
    "path" : "~/Projects/r_workshop/scripts/R_intro_codes.R",
    "project_path" : "scripts/R_intro_codes.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_source"
}